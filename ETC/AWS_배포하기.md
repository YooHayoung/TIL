# AWS 배포하기


### AWS EC2 인스턴스 생성 방법
- 내용 추가 하기


### AWS EC2 인스턴스 생성 후 ssh를 통해 접속한다
```shell
$ ssh -i ./pem파일 ubuntu@EC2 인스턴스의 퍼블릭 IPv4 주소
$
```
`ex) $ ssh -i ./test.pem ubuntu@00.00.000.00`
위와 같이 `shell`에서 명령을 입력하여 접속한다.

추가로 ssh 접속을 종료하려면 `$ exit` 명령을 입력하면 된다.


### 스프링 프로젝트 빌드하기
개발한 스프링 프로젝트를 빌드하는 방법을 여러가지 봤지만 아직 개발 및 배포환경 분리와 이를 빌드하는 방법에 대해 재대로 숙지하지 못했다. 내가 수행한 방법은 다음과 같다.

1. 우측 `Gradle`에서 `build` 클릭
2. `bootJar` 클릭하여 빌드.
3. 빌드가 완료되면 프로젝트 폴더의 `build/libs` 폴더에 빌드 파일이 생성된다.
	- 파일명은 `프로젝트명-0.0.1-SNAPSHOT.jar`로 생성된다.

개발 환경을 분리하고 원하는 환경으로 빌드하는 방법을 공부하고 적용하여 추가할 계획이다.



### 리액트 프로젝트 빌드하기
개발한 리액트 프로젝트를 빌드하려면 다음 과정을 거친다.

1. 프로젝트 폴더로 접근한다.
2. 터미널에 다음 명령을 입력한다.
	- `$ npm run build`
3. 프로젝트 폴더에 `build` 폴더가 생성된다. 이 `build`폴더를 배포 서버에 옮겨 배포하면 된다.



### 프로젝트 빌드 파일 및 폴더를 로컬에서 배포 환경(EC2)으로 옮기기
나는 로컬에서 개발한 프로젝트를 빌드하고 파일 전송 시스템인 파일질라를 이용하여 이를 배포 서버에 옮겼다.
파일질라에서 좌상단의 사이트 관리자 아이콘을 클릭하고 다음을 입력하고 연결 버튼을 누르면 된다.

1. 프로토콜 - SFTP 선택
2. 호스트 - EC2 인스턴스의 퍼블릭 IPv4 주소 입력
3. 로그온 유형 - 키 파일 선택
4. 사용자 - ubuntu <- ec2 인스턴스의 사용자 이름을 입력
5. 키 파일 선택 - ec2 인스턴스 생성시 다운로드한 키 파일을 선택해주면 된다.
6. 연결 버튼 클릭

위 과정을 거치면 파일질라를 이용하여 내 로컬 서버에서 ec2 서버에 파일을 전송할 수 있다. 스프링과 리액트 프로젝트를 빌드한 것을 각각 원하는 위치로 전송하자.

///////////
nginx - 리액트 실행 방법 추가할 것
///////////


### 스프링 빌드 파일 실행
빌드 파일을 원하는 위치로 옮겼으면 이를 실행해줘야 한다. 파일의 접근 권한을 변경하여 실행 가능하도록 해준다.
```shell
$ sudo chmod 711 빌드파일.jar
$
```
이 후, 빌드 파일을 백그라운드로 실행시켜준다.
```shell
$ nohup java -jar 빌드파일.jar &
$
```


### Nginx 서버 재시작
리액트 빌드 폴더를 적용하려면 Nginx 서버를 재시작 해줘야한다. 다음 명령을 입력하자.
```shell
$ sudo service nginx restart
$
```


이제 EC2 인스턴스의 퍼블릭 IPv4 주소와 설정해둔 포트로 접속하면 배포된 프로젝트를 확인할 수 있다.




## EC2 CPU 사용율 100% - EC2 인스턴스 동작 멈출 때 : 해결
스프링 프로젝트 파일 실행 후 1~2시간이 지나면 어느 순간 EC2 서버가 멈추는 현상이 발생했다. ssh에 접속하여 확인하려해도 접속 자체가 되지않아 애를 먹었다.  며칠간 검색을 통해 여러 글을 확인해보니 여러 원인이 있을 수 있다고 했다.

1. EC2의 너무 낮은 메모리 or 우리가 돌리는 웹 애플리케이션의 메모리가 EC2의 스펙보다 높은 경우
2. 누군가 내 EC2를 해킹…
3. EC2 인스턴스의 하드웨어 문제

나의 경우 1번에 해당하였다. 아직 미숙한 개발실력탓에 애플리케이션이 메모리를 많이 잡아먹어서 그런지 단지 EC2의 1GB의 메모리가 부족했던 탓인지는 아직 확인하지 못했다. 차차 공부하고 프로젝트를 유지보수하여 원인을 파악하고 수정할 것이다.

1번의 경우, SWAP 메모리 공간을 지정해주어 해결할 수 있다고 했다. SWAP 메모리는 RAM이 부족할 경우, 하드디스크의 일정 공간을 마치 RAM 처럼 사용할 수 있게 해준다. 이를 통해 우리는 마치 RAM을 증설한 듯한 효과를 볼 수 있다.

AWS에서는 RAM 크기에 따른 SWAP 공간을 다음과 같이 추천해줬다.

- RAM 물리 용량 2GB 이하 : RAM 용량의 2배, 최소 32MB
- RAM 물리 용량 2GB < x < 32GB : 4GB + (RAM - 2GB)
- RAM 물리 용량 32GB 이상 : RAM 용량과 같은 크기

나의 경우 EC2 프리티어를 사용하여 1GB의 RAM 용량을 가지기 때문에 스왑 공간 크기는 2GB로 잡았다. 아래는 스왑 영역을 지정하는 과정이다. 내 EC2 인스턴스는 ubuntu 환경이다. 스왑 영역을 지정하는 과정은 다음 게시물을 참고했다. 
[AWS EC2 프리티어에서 메모리 부족현상 해결방법](https://sundries-in-myidea.tistory.com/102)

1. 먼저 EC2 인스턴스에 접속하여 swap 메모리를 할당한다.
```shell
$ sudo dd if=/dev/zero of=/swapfile bs=128M count=16
```
	- dd 명령어 설명
	- 128MB씩 16개의 공간을 만들도록 하였다.

2. 스왑 파일에 대한 읽기 및 쓰기 권한을 부여한다.
```shell
$ sudo chmod 600 /swapfile
```

3. 스왑 영역을 설정한다.
```shell
$ sudo mkswap /swapfile
```

4. 스왑 공간에 스왑 파일을 추가하여 스왑 파일을 즉시 사용할 수 있도록 한다.
```shell
$ sudo swapon /swapfile
```

5. 위 과정이 성공했는지 확인한다.
```shell
$ sudo swapon -s
```

6. `/etc/fstab` 파일을 편집하여 부팅시 스왑 파일을 활성화한다.
```shell
$ sudo vi /etc/fstab

# 파일 마지막에 추가
/swapfile swap swap defaults 0 0
```
추가하면 편집을 저장하고 종료한다.

7. `free` 명령을 통해 적용이 완료됬는지 확인한다.
```shell
$ free
               total        used        free      shared  buff/cache   available
Mem:          991064      659004       71644         660      260416      169444
Swap:        2097148      202752     1894396

$
```
스왑 영역이 할당된 것을 확인할 수 있다.

스왑 영역을 할당해주고 나서 해당 문제가 해결되었다.


- - - -
참고한 게시물
[AWS EC2 인스턴스에 접속하기 (MAC)](https://soobarkbar.tistory.com/223)
[AWS 1편: EC2 생성 후 Spring Boot 띄우기 :: 뱀귤 블로그](https://bcp0109.tistory.com/356)
[01. 앱 내 서버에 배포하기 (AWS EC2, nginx) :: Hov log](https://blog.leehov.in/37)
[AWS EC2 프리티어에서 메모리 부족현상 해결방법](https://sundries-in-myidea.tistory.com/102)